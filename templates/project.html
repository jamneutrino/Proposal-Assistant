<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project.name }} - Project Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; }
        .item-list { margin-top: 2rem; }
        .total { margin-top: 1rem; font-weight: bold; }
        .translation-section {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
        }
        .clear-button {
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ project.name }}</h2>
            <div>
                <button id="generateWordBtn" class="btn btn-primary me-2">Generate Word</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Projects</a>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="itemForm" class="row g-3">
                    <div class="col-md-4">
                        <label for="itemSelect" class="form-label">Select Item</label>
                        <select class="form-select" id="itemSelect" required>
                            <option value="">Choose...</option>
                            {% for item in items %}
                            <option value="{{ item }}">{{ item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quantity" min="1" value="1" required>
                    </div>
                    <div class="col-md-4">
                        <label for="price" class="form-label">Price</label>
                        <input type="number" class="form-control" id="price" min="0.01" step="0.01" required>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Add Item</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="translation-section">
            <h3>Translated to Words</h3>
            <p id="translationText" class="mb-0" style="white-space: pre-line">{{ translation }}</p>
        </div>

        <div class="item-list">
            <div class="d-flex justify-content-between align-items-center">
                <h3>Added Items</h3>
                <button id="clearButton" class="btn btn-danger">Clear All Items</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTable">
                        {% for item in project.items %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>${{ "%.2f"|format(item.price) }}</td>
                            <td>${{ "%.2f"|format(item.quantity * item.price) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="total" id="totalAmount">
                Total: ${{ "%.2f"|format(project.items|sum(attribute='price')|float * project.items|sum(attribute='quantity')|float) }}
            </div>
        </div>
    </div>

    <script>
        const itemSelect = document.getElementById('itemSelect');
        const priceInput = document.getElementById('price');
        const generateWordBtn = document.getElementById('generateWordBtn');
        
        // Initialize price cache
        const priceCache = {{ price_cache|tojson|safe }};

        // Generate Word document
        generateWordBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/generate_word/{{ project.id }}', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = '{{ project.name }}_proposal.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const errorData = await response.json();
                    console.error('Server error:', errorData.error);
                    alert('Failed to generate Word document: ' + errorData.error);
                }
            } catch (error) {
                console.error('Error generating Word document:', error);
                alert('Error generating Word document: ' + error.message);
            }
        });

        // Function to update price when item is selected
        itemSelect.addEventListener('change', async () => {
            const selectedItem = itemSelect.value;
            if (selectedItem) {
                // First check cache
                if (selectedItem in priceCache) {
                    priceInput.value = priceCache[selectedItem].toFixed(2);
                } else {
                    // If not in cache, fetch from server
                    const response = await fetch(`/get_price/${encodeURIComponent(selectedItem)}`);
                    const data = await response.json();
                    if (data.price !== null) {
                        priceInput.value = data.price.toFixed(2);
                    } else {
                        priceInput.value = ''; // Clear price if not found
                    }
                }
            } else {
                priceInput.value = ''; // Clear price if no item selected
            }
        });

        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const item = itemSelect.value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const price = parseFloat(priceInput.value);

            const response = await fetch('/add_item/{{ project.id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ item, quantity, price })
            });

            const data = await response.json();
            if (data.success) {
                updateTable(data.items);
                updateTranslation(data.translation);
                document.getElementById('itemForm').reset();
            }
        });

        document.getElementById('clearButton').addEventListener('click', async () => {
            if (confirm('Are you sure you want to clear all items?')) {
                const response = await fetch('/clear_items/{{ project.id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                if (data.success) {
                    updateTable(data.items);
                    updateTranslation(data.translation);
                }
            }
        });

        function updateTable(items) {
            const tbody = document.getElementById('itemsTable');
            tbody.innerHTML = '';
            let total = 0;

            items.forEach(item => {
                const row = document.createElement('tr');
                const itemTotal = item.quantity * item.price;
                total += itemTotal;

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>$${itemTotal.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('totalAmount').textContent = `Total: $${total.toFixed(2)}`;
        }

        function updateTranslation(translation) {
            document.getElementById('translationText').textContent = translation;
        }
    </script>
</body>
</html> 