{% extends "base.html" %}

{% block title %}Admin{% endblock %}

{% block nav_admin %}text-gray-900 border-b-2 border-blue-500{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Items</h2>
        
        <!-- Add New Item Form -->
        <form id="addItemForm" class="mb-6 flex gap-4 items-end" enctype="multipart/form-data">
            <div class="flex-grow">
                <label for="newItemName" class="block text-sm font-medium text-gray-700 mb-1">New Item Name</label>
                <input type="text" id="newItemName" name="name" required
                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div class="flex-grow">
                <label for="newItemImage" class="block text-sm font-medium text-gray-700 mb-1">Image (Optional)</label>
                <input type="file" id="newItemImage" name="image" accept="image/*"
                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <button type="submit" 
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Add Item
            </button>
        </form>

        <!-- Items List -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Item Name</th>
                        <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Image</th>
                        <th class="text-right py-3 px-4 text-sm font-semibold text-gray-600">Actions</th>
                    </tr>
                </thead>
                <tbody id="itemsTable" class="divide-y divide-gray-200">
                    {% for item in items %}
                    <tr class="hover:bg-gray-50" data-item="{{ item.name }}">
                        <td class="py-3 px-4 text-sm text-gray-800">
                            <span class="item-name">{{ item.name }}</span>
                            <input type="text" class="hidden w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 edit-input" value="{{ item.name }}">
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-800">
                            {% if item.image_path %}
                            <img src="{{ item.image_path }}" alt="{{ item.name }}" class="h-12 w-auto">
                            {% else %}
                            No image
                            {% endif %}
                            <input type="file" class="hidden w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 edit-image" accept="image/*">
                            <label class="hidden keep-image-label">
                                <input type="checkbox" class="keep-image" checked> Keep existing image
                            </label>
                        </td>
                        <td class="py-3 px-4 text-sm text-right">
                            <button class="edit-btn px-3 py-1 text-blue-600 hover:text-blue-800 transition-colors">
                                Edit
                            </button>
                            <button class="save-btn hidden px-3 py-1 text-green-600 hover:text-green-800 transition-colors">
                                Save
                            </button>
                            <button class="cancel-btn hidden px-3 py-1 text-gray-600 hover:text-gray-800 transition-colors">
                                Cancel
                            </button>
                            <button class="delete-btn px-3 py-1 text-red-600 hover:text-red-800 transition-colors">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add new item
    document.getElementById('addItemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const response = await fetch('/admin/items/add', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to add item');
        }
    });

    // Edit item
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            row.querySelector('.item-name').classList.add('hidden');
            row.querySelector('.edit-input').classList.remove('hidden');
            row.querySelector('.edit-image').classList.remove('hidden');
            if (row.querySelector('.keep-image-label')) {
                row.querySelector('.keep-image-label').classList.remove('hidden');
            }
            row.querySelector('.edit-btn').classList.add('hidden');
            row.querySelector('.save-btn').classList.remove('hidden');
            row.querySelector('.cancel-btn').classList.remove('hidden');
            row.querySelector('.delete-btn').classList.add('hidden');
        });
    });

    // Cancel edit
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            row.querySelector('.item-name').classList.remove('hidden');
            row.querySelector('.edit-input').classList.add('hidden');
            row.querySelector('.edit-image').classList.add('hidden');
            if (row.querySelector('.keep-image-label')) {
                row.querySelector('.keep-image-label').classList.add('hidden');
            }
            row.querySelector('.edit-btn').classList.remove('hidden');
            row.querySelector('.save-btn').classList.add('hidden');
            row.querySelector('.cancel-btn').classList.add('hidden');
            row.querySelector('.delete-btn').classList.remove('hidden');
            
            // Reset input values
            row.querySelector('.edit-input').value = row.querySelector('.item-name').textContent;
            row.querySelector('.edit-image').value = '';
            if (row.querySelector('.keep-image')) {
                row.querySelector('.keep-image').checked = true;
            }
        });
    });

    // Save edit
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const row = this.closest('tr');
            const oldName = row.dataset.item;
            const newName = row.querySelector('.edit-input').value.trim();
            const imageFile = row.querySelector('.edit-image').files[0];
            const keepImage = row.querySelector('.keep-image')?.checked ?? false;
            
            // Allow save if name changes OR if there's a new image OR if we're removing the image
            if (newName && (newName !== oldName || imageFile || !keepImage)) {
                const formData = new FormData();
                formData.append('oldName', oldName);
                formData.append('newName', newName);
                if (imageFile) {
                    formData.append('image', imageFile);
                }
                formData.append('keepImage', keepImage);

                const response = await fetch('/admin/items/edit', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to update item');
                }
            }
        });
    });

    // Delete item
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to delete this item?')) {
                const row = this.closest('tr');
                const name = row.dataset.item;
                
                const response = await fetch('/admin/items/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete item');
                }
            }
        });
    });
});
</script>
{% endblock %} 